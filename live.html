<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui">
	<meta name="referrer" content="no-referrer">
	<title>ç›´æ’­</title>

	<style type="text/css">
		html, body {width:100%;height:100%;margin:auto;overflow:hidden;}
		body {display:flex; flex-direction:column;}
		#live {display:flex; flex-direction:column;}
		#top {flex:auto;height:3rem;order:1;background: black;border:none;}
		#top_close {height:100%;width:3rem;color:white;background-color: black;border:none;float:right}
		#player {flex:auto; order:2;border:none;}
		#comment {flex:auto; order:3;height:10rem;background: black;color:white}
		#sendMessage {height:1.3rem;width:3rem;color:white;background-color:darkgray;border:none;border-radius: 10px}
		#commentInput {margin:0.5rem 0 0 1.8rem; border-radius:10px}
		#commentE1{color:darkmagenta}
		#commentE2{color:darkorange}
		#commentE3{color:deeppink}
		#commentE4{color:dodgerblue}
	  </style>
</head>

<body>
	<!--é¡µé¢å®¹å™¨-->
	<div id="live"></div>
	
	<!-- å¼•å…¥reactæ ¸å¿ƒåº“ -->
	<script type="text/javascript" src="lib/react.development.js"></script>
	<!-- å¼•å…¥react-domï¼Œç”¨äºæ”¯æŒreactæ“ä½œDOM -->
	<script type="text/javascript" src="lib/react-dom.development.js"></script>
	<!-- å¼•å…¥babelï¼Œç”¨äºå°†jsxè½¬ä¸ºjs -->
	<script type="text/javascript" src="lib/babel.min.js"></script>
	<!-- å¼•å…¥è¥¿ç“œè§†é¢‘åº“ -->
	<script src="lib/xg.index.js" charset="utf-8"></script>
    <script src="lib/xg.index.min.js" charset="utf-8"></script>


	<script type="text/babel">

	//å‚è€ƒdivçš„å®ç°æ–¹å¼ï¼šç‚¹èµçš„å¿ƒå‹åŠ¨æ•ˆ
	function heart(e, t, a) {
		function r() {
			for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999;position:absolute");
			requestAnimationFrame(r)
		}
		function n() {
			var t = "function" == typeof e.onclick && e.onclick;
			e.onclick = function(e) {
				t && t(),
				o(e)
			}
		}
		function o(e) {
			var a = t.createElement("div");
			a.className = "heart",
			s.push({
				el: a,
				x: e.clientX - 5,
				y: e.clientY - 5,
				scale: 1,
				alpha: 1,
				color: c()
			}),
			t.body.appendChild(a)
		}
		function i(e) {
			var a = t.createElement("style");
			a.type = "text/css";
			try {
				a.appendChild(t.createTextNode(e))
			} catch(t) {
				a.styleSheet.cssText = e
			}
			t.getElementsByTagName("head")[0].appendChild(a)
		}
		function c() {
			return "rgb(" + ~~ (255 * Math.random()) + "," + ~~ (255 * Math.random()) + "," + ~~ (255 * Math.random()) + ")"
		}
		var s = [];
		e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame ||
		function(e) {
			setTimeout(e, 1e3 / 60)
		}

		i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"),
		n(),
		r()
		}


		//æ»‘åŠ¨æ§åˆ¶ç›¸å…³
		var startX = 0,startY = 0;
		var valid = true;
		var touchtime = new Date().getTime(); 
		var player;	
		var liveList;	
		var index=0;
		//è¯„è®ºæ¡†åˆ—è¡¨æœ¬åœ°è°ƒæµ‹
		var testCommentList=['å¤§æ˜: \xa0 hehe','äºŒæ˜: \xa0 æ”¯æŒæ”¯æŒ','é›¨ğŸŸ: \xa0 å“ˆå“ˆå“ˆå“ˆå“ˆ','chouchouzhu: \xa0 ä¸é”™åŠ æ²¹ ~_~','é›ªç¢§: \xa0 666'];

		function Init(){
			try{
				console.log('init');
				
				var xhr = new XMLHttpRequest();
				xhr.open('GET', 'http://tiktok.kingfish404.cn/api/live/getlist', true);
				xhr.send();
				
				xhr.onreadystatechange = function () {
					if (xhr.readyState == 4 && xhr.status == 200) {
						var res = xhr.responseText;
						console.log(res);
						//res='[{"id":0,"author":"è¥¿ç“œæµ‹è¯•ç›´æ’­1","url":"http://sf1-hscdn-tos.pstatp.com/obj/media-fe/xgplayer_doc_video/hls/xgplayer-demo.m3u8","desc":"XGvideo1","createdAt":"2021-01-26T19:30:22.420Z","updatedAt":"2020-01-30T10:24:26.590Z","like":0,"comment":0,"share":0},{"id":1,"author":"è¥¿ç“œæµ‹è¯•ç›´æ’­2","url":"http://sf1-hscdn-tos.pstatp.com/obj/media-fe/xgplayer_doc_video/hls/xgplayer-demo.m3u8","desc":"XGvideo2","createdAt":"2021-01-26T19:30:22.420Z","updatedAt":"2020-01-30T10:24:26.590Z","like":0,"comment":0,"share":0},{"id":2,"author":"CCTV1","url":"http://ivi.bupt.edu.cn/hls/cctv1hd.m3u8","desc":"cctv1","createdAt":"2021-01-26T19:30:22.420Z","updatedAt":"2020-01-30T10:24:26.590Z","like":0,"comment":0,"share":0}]';
						liveList = JSON.parse(res); 
						ReactDOM.render(<Live author={liveList[0].author} commentList={testCommentList}/>,document.getElementById('live'));
					}
				};
				heart(window, document);
			}
			catch(e){
				console.log(e.message)
			}
		}
		Init();
		

		//æ»‘åŠ¨æ‰‹åŠ¿åŠŸèƒ½
		function touchStart(evt){
			try{
				if(new Date().getTime() - touchtime<500){
				console.log("dblClick");
				}
				else{
					touchtime = new Date().getTime();
				}
				var touch = evt.touches[0], //è·å–ç¬¬ä¸€ä¸ªè§¦ç‚¹
						x = Number(touch.pageX), //é¡µé¢è§¦ç‚¹Xåæ ‡
						y = Number(touch.pageY); //é¡µé¢è§¦ç‚¹Yåæ ‡
				//è®°å½•è§¦ç‚¹åˆå§‹ä½ç½®
				startX = x;
				startY = y;
			}
			catch(e){
				console.log(e.message)
			}
		}

		function touchMove(evt){
			try{
				var touch = evt.changedTouches[0], //è·å–ç¬¬ä¸€ä¸ªè§¦ç‚¹
						y = Number(touch.pageY); //é¡µé¢è§¦ç‚¹Yåæ ‡
				//åˆ¤æ–­æ»‘åŠ¨æ–¹å‘
				let distance=y-startY;
				if (distance>window.innerHeight*0.2) {
					//console.log(`ä¸‹æ»‘:${distance}`);
					slideDown();
				}else if(distance<-window.innerHeight*0.2){
					//console.log(`ä¸Šæ»‘:${distance}`);
					slideUp();
				}
			}
			catch(e){
				console.log(e.message)
			}
		}

		function slideUp(){
			if(!valid){
				return false;
			}
			if(index<liveList.length) index++;
			else return ;
			valid = false
			setTimeout(() => {
				let temp =[];
				if(index==0) temp=testCommentList; //è¯„è®ºåˆ—è¡¨æµ‹è¯•
				ReactDOM.render(<Live author={liveList[index].author} commentList={temp}/>,document.getElementById('live'));
				player.src =liveList[index].url;
				player.play();
				valid = true;
			}, 200)
		}
		function slideDown(){
			if(!valid){
				return false;
			}
			if(0<index&&index<=liveList.length) index--;
			else return ;
			valid = false;
			setTimeout(() => {
				let temp =[];
				if(index==0) temp=testCommentList;
				ReactDOM.render(<Live author={liveList[index].author} commentList={temp}/>,document.getElementById('live'));
				player.src =liveList[index].url;
				player.play();
				valid = true;
			}, 200)
		}
	
		function bindEvent(){
			document.getElementById("player").addEventListener('touchstart',touchStart,false);
			document.getElementById("player").addEventListener('touchmove',touchMove,false);
		}
		

		class Live extends React.Component{

			state = {};

			death = ()=>{
				//å¸è½½ç»„ä»¶
				ReactDOM.unmountComponentAtNode(document.getElementById('live'))
			}

			sendMessage = ()=>{
				const {commentInput} = this.refs;
				testCommentList.shift();
				testCommentList.push("chouchouzhu: \xa0 "+commentInput.value);
				commentInput.value="";
				ReactDOM.render(<Live author={liveList[0].author} commentList={testCommentList}/>,document.getElementById('live'));
			}

			componentDidMount(){
					//this.setState(liveList.list[0]);
					
					//åˆå§‹åŒ–è¥¿ç“œæ’­æ”¾å™¨
				    player = new HlsPlayer({
					id: 'player',
					url: liveList[0].url,
					isLive: true,
					autoplay: true,
					playsinline: true,
					height: window.innerHeight*0.7,
					width: window.innerWidth,
					controls:false,
					closeVideoClick: true,
					closeVideoDblclick:true,
					closeVideoTouch:true,
				});
				bindEvent();
			}
			
			render(){
				const {author,commentList} = this.props;
				return (
				<div>
					<div id="top" style={{color:'white' ,position:'relative'}}>
						<p style={{color:'white', position:'absolute'}}>
							<img src='s1.ico' />
							&nbsp;&nbsp;{author}
						</p>
						<button id="top_close" onClick={this.death}>X</button>
					</div>
					<div id='player'>
					</div>

					<div id="comment">
						<dd id="commentE1">{commentList[0]}</dd>
						<dd id="commentE2">{commentList[1]}</dd>
						<dd id="commentE3">{commentList[2]}</dd>
						<dd id="commentE4">{commentList[3]}</dd>
						<dd id="commentE5">{commentList[4]}</dd>
						<input type="text" placeholder='è¯´ç‚¹ä»€ä¹ˆå§...' ref="commentInput" id="commentInput" ></input>
						<button id="sendMessage" onClick={this.sendMessage}>send</button>
					</div>	
				</div>		
				)
			}
		}
		

	</script>
</body>
</html>